{{ define "settings_appearance.html" }}
{{ template "settings_layout_start" . }}
                <div class="settings-split">
                    <div class="settings-form-column settings-panel">
                        <form method="post" action="/settings/appearance" enctype="multipart/form-data" id="appearance-settings-form">
                    <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">

                    {{ if not .CanSelectTheme }}
                    <div class="highlight-note">Theme selection is disabled by the server administrator.</div>
                    {{ end }}

                    {{ if .CanSelectTheme }}
                    <div class="section" id="section-themes">
                        <h2>Built-in themes</h2>
                        <p class="meta">Pick one theme for the whole app. Click a card to select.</p>
                        <div class="theme-preview-list" data-theme-pages>
                            {{ if .HasDefaultCustomCSS }}
                            <label class="theme-preview {{ if eq $.Theme.ProfileTheme $.DefaultCustomTheme.Name }}is-selected{{ end }}" data-preview-theme="{{ $.DefaultCustomTheme.Name }}" data-page="1">
                                <input type="radio" name="profile_theme" value="{{ $.DefaultCustomTheme.Name }}" {{ if eq $.Theme.ProfileTheme $.DefaultCustomTheme.Name }}checked{{ end }} class="theme-choice" aria-label="{{ $.DefaultCustomTheme.Label }}" data-page="1">
                                <div class="theme-preview-header">
                                    <span>{{ $.DefaultCustomTheme.Label }}</span>
                                </div>
                                <div class="theme-preview-description meta">{{ $.DefaultCustomTheme.Description }}</div>
                                {{ if .DefaultCustomCSSURL }}
                                <p class="meta">Active file: <a class="link-inline" href="{{ .DefaultCustomCSSURL }}" target="_blank" rel="noreferrer">{{ .DefaultCustomCSSName }}</a></p>
                                {{ end }}
                            </label>
                            {{ end }}
                            {{ range .Themes }}
                            <label class="theme-preview {{ if eq $.Theme.ProfileTheme .Name }}is-selected{{ end }}" data-preview-theme="{{ .Name }}" data-page="{{ .Page }}">
                                <input type="radio" name="profile_theme" value="{{ .Name }}" {{ if eq $.Theme.ProfileTheme .Name }}checked{{ end }} class="theme-choice" aria-label="{{ .Label }}" data-page="{{ .Page }}">
                                <div class="theme-preview-header">
                                    <span>{{ .Label }}</span>
                                </div>
                                <div class="theme-preview-description meta">{{ .Description }}</div>
                                <div class="theme-preview-swatches" aria-hidden="true">
                                    <span class="theme-swatch surface"></span>
                                    <span class="theme-swatch panel"></span>
                                    <span class="theme-swatch accent"></span>
                                    <span class="theme-swatch ink"></span>
                                </div>
                            </label>
                            {{ end }}
                        </div>
                        <div class="theme-pagination">
                            <button type="button" class="ghost" id="theme_page_prev" aria-label="Previous page">Previous</button>
                            <span class="meta" id="theme_page_label">Page</span>
                            <button type="button" class="ghost" id="theme_page_next" aria-label="Next page">Next</button>
                        </div>
                        <button type="submit" class="ghost" name="action" value="save-theme">Save theme</button>
                    </div>
                    {{ end }}

                    {{ if .CanCustomCSS }}
                    <div class="section" id="section-custom-css">
                        <h2>Custom CSS</h2>
                        <div class="highlight-note">Upload a CSS file or paste overrides. Custom styles load after built-in themes. Uploading a CSS file overwrites your previous custom CSS and clears inline overrides.</div>
                        {{ if .Theme.CustomCSSURL }}
                        <div class="css-file-row">
                            <p class="meta">Current file: <a class="link-inline" href="{{ .Theme.CustomCSSURL }}" target="_blank" rel="noreferrer">{{ .Theme.CustomCSSURL }}</a></p>
                            <button type="submit" class="icon-button" name="action" value="delete-css" aria-label="Delete CSS file">
                                <span class="icon icon-trash" aria-hidden="true"></span>
                            </button>
                        </div>
                        {{ end }}
                        <div class="custom-css-row">
                            <div class="custom-css-upload">
                                <label for="custom_css_file">Upload CSS file</label>
                                <input type="file" id="custom_css_file" name="custom_css_file" accept=".css">
                            </div>
                            <button type="submit" class="ghost" name="action" value="upload-css">Upload</button>
                        </div>
                        <label for="inline_css">Inline CSS</label>
                        <textarea id="inline_css" name="inline_css" rows="6" placeholder=":root { --brand: #000; }">{{ .Theme.InlineCSS }}</textarea>
                        <p class="meta">Use <code>[data-theme="classic"]</code> to scope to a specific theme.</p>
                        <button type="submit" class="ghost" name="action" value="save-css">Save CSS</button>
                    </div>
                    {{ else if .CanSelectTheme }}
                    <div class="highlight-note">Custom CSS is disabled by the server administrator.</div>
                    {{ end }}

                    {{ if or .CanSelectTheme .CanCustomCSS }}
                    <div class="section"></div>
                    {{ end }}
                        </form>
                    </div>
                    {{ template "settings_profile_preview" . }}
                </div>
    <script src="/static/js/settings-nav.js"></script>
    <script src="/static/js/settings-preview.js"></script>
    <script src="/static/js/settings-profile.js"></script>
    <script src="/static/js/settings-appearance.js"></script>
    <script>
        initSettingsNav();
        initAppearanceAutoSave();
        if (window.initProfilePreview) {
            window.initProfilePreview();
        }
        (function () {
            const cards = Array.from(document.querySelectorAll(".theme-preview"));
            const pageLabel = document.getElementById("theme_page_label");
            const prevBtn = document.getElementById("theme_page_prev");
            const nextBtn = document.getElementById("theme_page_next");

            function maxPage() {
                return cards.reduce((max, card) => Math.max(max, parseInt(card.dataset.page || "1", 10)), 1);
            }

            let currentPage = (() => {
                const checked = document.querySelector(".theme-choice:checked");
                if (checked && checked.dataset.page) {
                    return parseInt(checked.dataset.page, 10);
                }
                return 1;
            })();

            function setPage(page) {
                const total = maxPage();
                currentPage = Math.min(Math.max(page, 1), total);
                cards.forEach((card) => {
                    const cardPage = parseInt(card.dataset.page || "1", 10);
                    card.classList.toggle("is-hidden", cardPage !== currentPage);
                });
                if (pageLabel) {
                    pageLabel.textContent = `Page ${currentPage} of ${total}`;
                }
                if (prevBtn) prevBtn.disabled = currentPage <= 1;
                if (nextBtn) nextBtn.disabled = currentPage >= total;
            }

            setPage(currentPage);

            if (prevBtn) {
                prevBtn.addEventListener("click", () => setPage(currentPage - 1));
            }
            if (nextBtn) {
                nextBtn.addEventListener("click", () => setPage(currentPage + 1));
            }

            cards.forEach((card) => {
                const input = card.querySelector(".theme-choice");
                card.addEventListener("click", (event) => {
                    if (!input) return;
                    const wasChecked = input.checked;
                    input.checked = true;
                    cards.forEach((c) => c.classList.toggle("is-selected", c === card));
                    if (input.dataset.page) {
                        setPage(parseInt(input.dataset.page, 10));
                    }
                    if (!wasChecked && event.target !== input) {
                        input.dispatchEvent(new Event("change", { bubbles: true }));
                    }
                });
                card.addEventListener("keydown", (e) => {
                    if (e.key === " " || e.key === "Enter") {
                        e.preventDefault();
                        card.click();
                    }
                });
                card.setAttribute("tabindex", "0");
            });
        })();
    </script>
{{ template "settings_layout_end" . }}
{{ end }}
